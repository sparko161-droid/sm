# SM Codex Portal · ARCHITECTURE_GITHUB_BACKEND

Этот документ описывает целевую архитектуру портала «Конструктор внутреннего портала Стандарт Мастер» 
в модели **GitHub backend + n8n + SPA (Vanilla JS)**.

Документ является надстройкой над `ARCHITECTURE.md` и определяет,
как данные хранятся, читаются и изменяются в системе.

---

## 1. Общий обзор архитектуры

Ключевые принципы:

- **GitHub — это backend и база данных.**
- **JSON/Markdown-файлы — единственный источник данных.**
- **n8n — единственная точка записи и авторизации.**
- **SPA на Vanilla JS — единственный клиент для чтения данных.**
- **Нет классического backend-сервера и баз данных (Postgres, Mongo и т.п.).**
- **Нет пользователей, регистрации и прогресса.**
- **Авторизация нужна только для доступа к калькуляторам и конструктору.**

---

## 2. Хранение данных

Все данные портала хранятся в репозитории GitHub в виде файлов:

- `content/sections.json` — реестр разделов и их страниц.
- `content/pages/**/*.json` — страницы в формате step-by-step.
- `content/filters.json` — конфигурация фильтров.
- `content/calculators.json` — декларативное описание калькуляторов.
- Markdown-файлы (`docs/**/*.md`) — документация и регламенты.

Требования:

- данные должны быть **строго валидным JSON**;
- структура файлов описана в `CONTENT_MODEL.md`;
- изменения в этих файлах **нельзя** выполнять напрямую с фронтенда.

---

## 3. Чтение данных (SPA → GitHub API)

Фронтенд **никогда не пишет** данные в GitHub напрямую.  
Он только **читает** их через GitHub API или raw-доступ.

Пример чтения файла:

- `GET /repos/{owner}/{repo}/contents/content/sections.json`
- декодирование `content` из base64;
- парсинг JSON на стороне SPA.

Фронтенд использует `githubClient` (описан в `DEV_GUIDE.md`), который инкапсулирует:

- базовый URL GitHub API;
- чтение сырых файлов;
- декодирование base64;
- обработку ошибок.

---

## 4. Изменение данных (SPA → n8n → GitHub API)

Запрещено:

- выполнять `PUT /contents` с фронтенда;
- использовать токены GitHub в SPA;
- хранить секреты в коде и конфигурации фронтенда.

Все изменения следуют цепочке:

1. SPA отправляет запрос на **n8n webhook**.
2. n8n:
   - авторизует запрос (пароль/токен/роль),
   - валидирует входной JSON,
   - считывает текущую версию файла из GitHub,
   - формирует новый контент,
   - вызывает GitHub API для записи (`PUT /contents`),
   - возвращает SPA результат и новый `sha`.

Подробности по webhook-ам и workflow-ам описаны в `N8N_INTEGRATION.md`.

---

## 5. Модель страниц: step-by-step

Каждая страница описана в `content/pages/**/*.json` и имеет структуру:

- `id` — уникальный идентификатор страницы;
- `sectionId` — к какому разделу относится;
- `slug` — URL-часть;
- `title` — заголовок;
- `steps[]` — массив шагов.

Каждый шаг:

- `id`
- `title`
- `description` (опционально)
- `blocks[]` — массив блоков контента.

Каждый блок:

- `id`
- `type` — один из типов, описанных в `CONTENT_MODEL.md`;
- `data` — содержимое, зависящее от типа блока.

Рендеринг step-by-step реализуется в SPA через `StepRenderer` и `BlocksRenderer` (см. `CONSTRUCTOR_GUIDE.md` и `DEV_GUIDE.md`).

---

## 6. Фильтры и калькуляторы

- `content/filters.json` описывает:
  - линии поддержки (L1, L2, L3),
  - типы кейсов,
  - категории и другие фильтрующие признаки.

- `content/calculators.json` описывает:
  - список калькуляторов,
  - их `slug`,
  - человекочитаемые названия,
  - связи с n8n (например, `n8nCalcId`).

SPA:

- читает `filters.json` и `calculators.json` через GitHub API;
- использует их для отрисовки фильтров и списка калькуляторов;
- не хранит бизнес-логику мотивации — только UI.

---

## 7. Авторизация и безопасность

- Авторизация нужна **только** для:
  - доступа к калькуляторам;
  - работы в конструкторе.

- Пароли/токены:
  - **не хранятся** в GitHub;
  - проверяются внутри n8n workflow-ов;
  - передаются по защищённому каналу (на стороне инфраструктуры).

- SPA не знает,
  *как* именно сверяются пароли — только использует результат webhook-а.

Подробности по авторизации см. в `N8N_INTEGRATION.md`.

---

## 8. Ограничения

В рамках этой архитектуры запрещено:

- добавлять отдельный backend-сервер;
- использовать сторонние БД (Postgres, MySQL, MongoDB и т.п.);
- хранить секреты и пароли в репозитории;
- вводить сущности пользователей, регистрации и прогресса;
- изменять структуру контента в обход `CONTENT_MODEL.md`.

Все новые фичи и модули должны вписываться в модель:

> **GitHub backend + n8n + SPA (Vanilla JS) + JSON/MD контент.**

# SM Codex Portal · CONSTRUCTOR_GUIDE

Этот документ описывает **конструктор портала** — UI и логику,
с помощью которых редактируется контент в `content/` через n8n и GitHub.

---

## 1. Назначение конструктора

Конструктор предназначен для:

- создания и редактирования разделов, страниц, шагов и блоков;
- управления структурой `sections.json`;
- редактирования `filters.json` и `calculators.json`;
- подготовки JSON-данных для отправки в n8n webhook-ы.

Конструктор:

- не пишет в GitHub напрямую;
- не хранит логин/пароль, токены и секреты;
- работает только через n8n.

---

## 2. Маршруты и компоненты

Страница конструктора доступна по маршруту:

```text
#constructor
```

Основные компоненты SPA:

- **ConstructorShell** — корневой контейнер страницы.
- **SectionsPanel** — список разделов (`sections.json`).
- **PagesPanel** — список страниц внутри выбранного раздела.
- **StepsPanel** — список шагов выбранной страницы.
- **BlocksPanel** — блоки внутри выбранного шага.
- **PropertiesPanel** — редактирование полей конкретной сущности.

---

## 3. Локальная модель данных (до сохранения)

Внутри конструктора используется локальная модель:

```js
{
  sections,      // данные из sections.json
  pages,         // кэш страниц (pageId -> pageJson)
  filters,       // данные из filters.json
  calculators,   // данные из calculators.json
  dirtyFlags     // какие сущности изменены
}
```

Принципы:

- все изменения сначала попадают в локальное состояние;
- пользователь может отменять/переключаться без записи в GitHub;
- запись происходит явно через кнопку «Сохранить».

---

## 4. Операции конструктора

Конструктор должен поддерживать:

### 4.1. Операции с разделами

- создать раздел;
- переименовать раздел;
- изменить порядок разделов;
- удалить раздел (при отсутствии критичных зависимостей).

Все изменения отражаются в `sections.json`.

### 4.2. Операции со страницами

- создать страницу внутри раздела;
- изменить заголовок, slug, order;
- привязать страницу к файлу `pagePath`;
- удалить страницу (с предварительным подтверждением).

### 4.3. Операции со шагами

- добавить шаг;
- изменить заголовок и описание;
- изменить порядок шагов (drag & drop / кнопки вверх/вниз);
- удалить шаг.

### 4.4. Операции с блоками

- добавить блок указанного типа (`text`, `list`, `checklist`, `case`, `note`, `link`, `image`, `calc-link`);
- изменить данные блока;
- клонировать блок;
- переместить блок вверх/вниз;
- удалить блок.

---

## 5. Сохранение изменений

Сохранение всегда происходит через n8n:

- **Сохранение страницы**:
  - отправка полной модели страницы на webhook `/webhook/constructor/save-page`;
  - получение ответа с `success` и `newSha`;
  - обновление локального состояния.

- **Сохранение sections.json**:
  - отправка `sections` на `/webhook/constructor/save-sections`.

- **Сохранение filters.json**:
  - отправка `filters` на `/webhook/constructor/save-filters`.

Подробные форматы запросов/ответов описаны в `N8N_INTEGRATION.md`.

---

## 6. Авторизация в конструкторе

Доступ к конструктору должен защищаться авторизацией, реализованной через n8n:

- при входе на `#constructor`:
  - показывается форма ввода пароля/токена;
  - данные отправляются на `/webhook/constructor/auth`;
  - при успехе — выдается сессионный маркер (например, `sessionId`), который отправляется с последующими запросами;
  - при ошибке — доступ запрещается.

SPA не знает, как реализована проверка пароля — этим управляет n8n.

---

## 7. UX-принципы конструктора

- изменения должны быть **явными**:
  - подсветка несохранённых изменений;
  - подтверждения при удалении.
- интерфейс должен оставаться **простым**:
  - фокус на структуре и содержимом;
  - без перегрузки визуальными эффектами.
- при ошибках сохранения:
  - показывать человеку понятные сообщения;
  - не терять локальные изменения.

---

## 8. Расширение функционала

При добавлении новых типов блоков или новых сущностей:

- сначала обновите `CONTENT_MODEL.md`;
- затем обновите UI конструктора и Step/Blocks Renderer;
- в конце — зафиксируйте изменения в `CHANGELOG.md` с типом `[CONTENT]` или `[FRONT]`.

Конструктор является **основным инструментом работы с контентом** 
и должен всегда оставаться согласованным с архитектурой GitHub backend.
